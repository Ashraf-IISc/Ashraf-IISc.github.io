<!DOCTYPE html>
<html>
<head>
    <title>The Grimoire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/easymde.min.css') }}">
    <script src="{{ url_for('static', filename='js/Sortable.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/easymde.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>
<body>
    <div class="main-container fade-in">
        
        <div class="view-switcher">
            <div class="desktop-tabs">
                <span id="tab-tracker" class="active-view" onclick="switchView('tracker')">The Grimoire</span>
                <span id="tab-journal" class="inactive-view" onclick="switchView('journal')">The Chronicles</span>
            </div>
            
            <select id="mobile-nav" class="mobile-nav-dropdown" onchange="switchView(this.value)">
                <option value="tracker">The Grimoire</option>
                <option value="journal">The Chronicles</option>
            </select>

            <div class="settings-nav">
                <a href="/change_credentials" title="Account Settings">&#9881;</a>
                <a href="/logout" title="Log Out">&#10006;</a>
            </div>
        </div>
        <div id="view-tracker" class="scroll smooth-fade" style="display: block;">
            <div class="header">
                <span onclick="loadMonth(ENV.prevYear, ENV.prevMonth)" class="nav-link">&larr;</span>
                <h2 style="margin:0; font-size: 2.4rem;" id="month-title">{{ month_name }} {{ year }}</h2>
                <span onclick="loadMonth(ENV.nextYear, ENV.nextMonth)" class="nav-link">&rarr;</span>
            </div>
            
            <div class="grid" id="calendar">
                {% for week in cal_data %}{% for d in week %}
                    {% if not d %}<div class="day" style="visibility:hidden"></div>
                    {% else %}
                    <div class="day {{ 'is-today' if d.is_today }} {{ 'has-blog' if d.has_blog }}"
                        data-date="{{ d.date | e }}" data-tags="{{ d.tags | e }}" data-snapshot="{{ d.snapshot | e }}" 
                        data-blog="{{ d.has_blog }}" data-locked="{{ '1' if d.is_locked else '0' }}" 
                        data-status="{{ d.status | e }}">
                         <div class="cell-paper"></div>
                         <span class="cell-content">{{ d.day }}</span>
                    </div>
                    {% endif %}
                {% endfor %}{% endfor %}
            </div>
            
            <div id="editor">
                <div class="editor-header">
                    <h3 id="ed-date"></h3>
                    <div>
                        <span id="status-bar" style="margin-right: 10px;"></span>
                        <button class="btn-close" onclick="closeEditor()">Close</button>
                    </div>
                </div>
                
                <label style="font-weight: bold; font-size: 1.2rem; display: block; margin-bottom: 5px;">Priorities <span style="font-weight: normal; font-size: 0.9rem; font-style: italic;">(Drag to reorder)</span>:</label>
                <div class="tag-group" id="tag-container"></div>

                <form id="f-add-tag" class="add-tag-box">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="text" id="new-tag-name" placeholder="New Priority (max 60 chars)" maxlength="60" required>
                    <button type="submit">+ Add</button>
                </form>

                <form id="f-update">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="date" id="i-date">
                    <label style="font-weight: bold; font-size: 1.2rem; display: block; margin-bottom: 10px;">Journal Entry:</label>
                    <textarea id="i-text"></textarea>
                    <button type="submit" id="s-btn" class="btn-seal">Seal in Ink</button>
                </form>
            </div>
        </div>

        <div id="view-journal" class="scroll smooth-fade" style="display: none;">
            <div class="controls">
                <input type="text" id="search-box" placeholder="Search entries...">
                <button class="btn-toggle" id="btn-expand" onclick="toggleAll()">Expand All</button>
            </div>
            <div id="entries-container"></div>
        </div>

        <div id="color-picker">
            <div style="font-weight:bold; margin-bottom:10px; color:var(--ink); text-align:center;">Change Color</div>
            <div class="picker-controls">
                <select id="cp-tier" onchange="populateColorPicker()"><option value="any">Any Tier</option><option value="bold">Bold</option><option value="medium">Medium</option><option value="whisper">Whisper</option></select>
                <select id="cp-hue" onchange="populateColorPicker()"><option value="any">Any Hue</option><option value="red">Red</option><option value="orange">Orange</option><option value="yellow">Yellow</option><option value="green">Green</option><option value="cyan">Cyan</option><option value="blue">Blue</option><option value="purple">Purple</option><option value="pink">Pink</option></select>
            </div>
            <div id="color-options"></div>
            
            <hr style="border: 0; border-top: 1px dashed var(--parchment); margin: 12px 0;">
            
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                <input type="text" id="hex-color-input" placeholder="#RRGGBB" maxlength="7" style="width: 100%; box-sizing: border-box; padding: 8px; font-family: monospace; font-size: 1rem; border: 1px solid var(--parchment); border-radius: 4px; background: rgba(255,255,255,0.6);">
                <button type="button" class="btn-refresh-colors" style="width: 100%; padding: 8px;" onclick="selectHexColor()">Apply Hex</button>
            </div>
        </div>

        <div id="footnote-overlay" class="modal-overlay">
            <div class="footnote-modal fade-in">
                <div class="editor-header">
                    <h3 style="margin: 0; font-size: 1.8rem;">Add Footnote</h3>
                    <button class="btn-close" onclick="closeFootnoteModal()">Close</button>
                </div>
                <div style="font-style: italic; color: #666; margin-bottom: 10px;" id="fn-display-date"></div>
                
                <form id="f-footnote">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" id="fn-date">
                    <textarea id="fn-text"></textarea>
                    <button type="submit" class="btn-seal" style="margin-top: 15px;">Append to Chronicles</button>
                </form>
            </div>
        </div>

    </div>

    <script id="grimoire-env" type="application/json">
        {{ {
            'todayStr': today_str,
            'tagsData': tags_data,
            'logsData': logs_data,
            'csrfToken': csrf_token(),
            'prevYear': prev_year,
            'prevMonth': prev_month,
            'nextYear': next_year,
            'nextMonth': next_month
        } | tojson | safe }}
    </script>
    <script>
        const envScript = document.getElementById('grimoire-env');
        window.GRIMOIRE_ENV = envScript ? JSON.parse(envScript.textContent) : {};
    </script>
</body>
</html>